name: Create Release (Manual Upload)

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.1.2
  workflow_dispatch:  # Allow manual triggering

jobs:
  create-release:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Read release notes from CHANGELOG
      id: changelog
      run: |
        # Extract release notes for this version from CHANGELOG.md
        if [ -f "CHANGELOG.md" ]; then
          # Extract section for current version
          awk "/## \[${{ steps.get_version.outputs.VERSION }}\]/,/## \[/" CHANGELOG.md | head -n -1 > release_notes.txt
          
          # Add manual upload instructions
          echo "" >> release_notes.txt
          echo "## 📥 Download" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "**Note**: Executables are built locally and uploaded manually to avoid antivirus false positives." >> release_notes.txt
          echo "" >> release_notes.txt
          echo "- **ewexport.exe** - Windows executable (will be uploaded shortly)" >> release_notes.txt
          echo "- **release_info.json** - Build information and SHA256 hash" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "## 🛡️ Antivirus Information" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "If your antivirus flags the executable:" >> release_notes.txt
          echo "1. Verify the SHA256 hash in release_info.json" >> release_notes.txt
          echo "2. Add an exception for ewexport.exe" >> release_notes.txt
          echo "3. See [ANTIVIRUS.md](https://github.com/karllinder/ewexport/blob/main/ANTIVIRUS.md) for detailed guidance" >> release_notes.txt
        else
          echo "Release ${{ steps.get_version.outputs.VERSION }}" > release_notes.txt
          echo "" >> release_notes.txt
          echo "Executable will be uploaded manually." >> release_notes.txt
        fi
    
    - name: Create Release (Draft)
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body_path: release_notes.txt
        draft: true  # Create as draft for manual upload
        prerelease: false
        files: |
          ANTIVIRUS.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Post-creation notice
      run: |
        echo "🎉 Draft release created: ${{ steps.get_version.outputs.VERSION }}"
        echo ""
        echo "📝 Next steps:"
        echo "1. Run: python build_and_release.py"
        echo "2. Upload ewexport.exe to the draft release"
        echo "3. Publish the release"
        echo ""
        echo "🌐 Release URL: https://github.com/karllinder/ewexport/releases/tag/${{ steps.get_version.outputs.VERSION }}"